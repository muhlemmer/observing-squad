FROM golang:1.15.7 as builder

RUN mkdir /root/.ssh && chmod 700 /root/.ssh
	
# Clone the elrond-proxy-go repo 
RUN git clone -b master https://github.com/ElrondNetwork/elrond-proxy-go.git && cd elrond-proxy-go && git checkout --force tags/v1.1.16

# Proxy
WORKDIR /go/elrond-proxy-go/cmd/proxy
RUN go build

# ===== SECOND STAGE ======
FROM ubuntu:20.04

ENV workdir=/go/elrond-proxy-go/cmd/proxy
ENV uid=1000
RUN useradd -U -u ${uid} -d ${workdir} -M -s /sbin/nologin elrond

#Copy the built app to the container
COPY --from=builder "${workdir}" "${workdir}"
COPY configs/config.toml ${workdir}/config/
COPY entrypoint.sh /

WORKDIR ${workdir}
EXPOSE 8079
ENTRYPOINT [ "/entrypoint.sh" ]
CMD ["./proxy"]
